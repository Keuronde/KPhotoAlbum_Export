<html>
<head>
<meta charset="UTF-8"> 
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Test de la bibliotheque Mustache.js</title>
<script src="./mustache.js"></script>
<script src="./photos.js" charset="UTF-8"></script>
<script src="./tagGallery.js"></script>
<link rel="stylesheet" href="style_js.css" type="text/css" />
</head>
<body onload="refresh()">
  <div id="search"></div>
  <div id="tags"></div>
  <div id="photos"></div>

<script id="search_tpl" type="x-tmpl-mustache">
    <p style="display:inline-block;">Recherche :</p>
    <button style:"float:right" onclick="hideSearch()" id="hideSearch">Hide current search</button>
    <div id="hidableSearch">
    <!-- BEGIN recherche -->
	{{#currentSearch}}
    <div>
    <p style="display:inline-block;">{{category}}</p>
    {{^onlyone}}
    <button type="button" category="{{category}}" boolOp="{{boolOp}}" onclick="toggleBoolOp(this)">{{boolOp}}</button>
    {{/onlyone}}
    {{#values}}
    <button type="button" category="{{category}}" value="{{.}}" onclick="delCriteria(this)">{{category}} : <span style="value">{{.}}</button>
    {{/values}}
    </div>
	{{/currentSearch}}
    <!-- END recherche -->
    <button style:"float:left" onclick="reset()">Reset</button></div>
</script>
<script id="tags_tpl" type="x-tmpl-mustache">
  <ul>
  {{#categories}}
    <li>{{name}}
      <ul class="value">
        <!-- BEGIN values -->
        {{#values}}
        <li><button type="button" category="{{name}}" value="{{.}}" onclick="addCriteria(this)" class="currentSearchButton">{{.}}</button></li>
        {{/values}}
        <!-- END values -->
      </ul>
    </li>
  <!-- END tags -->
  {{/categories}}  
  </ul>
</script>
<script id="photos_tpl" type="x-tmpl-mustache">

    <div>
    {{#selectedPhotos}}
      <!-- BEGIN photos -->
      <a href="Photos/{{file}}" rel="lightbox[photos]"><img src="Photos/mini/{{file}}"/></a>
      <!-- END photos -->
    {{/selectedPhotos}}
    </div>
</script>
<script>
  nbPhotoPerPage = 20;
  
</script>


<script>


function addCriteria(theButton){
  tg_addCriteria({"category":theButton.getAttribute("category"),"value":theButton.getAttribute("value")});
  refresh();
}

function delCriteria(theButton){
  tg_delCriteria({"category":theButton.getAttribute("category"),"value":theButton.getAttribute("value")});
  refresh();
}
function toggleBoolOp(theButton){
  tg_toggleBoolOp({"category":theButton.getAttribute("category"),"boolOp":theButton.getAttribute("boolOp")});
  refresh();
}
function hideSearch(){
  if (document.getElementById('hidableSearch').style["display"]=="none"){
    document.getElementById('hidableSearch').style["display"]="block";
    document.getElementById('hideSearch').innerHTML = "Hide search"
  }else{
    document.getElementById('hidableSearch').style["display"]="none";
    document.getElementById('hideSearch').innerHTML = "Display search"
  }
}
function reset()
{
  tg_reset();
  refresh();
}

// Construct categories and their value
function computeCategory()
{
  var CategoryAndValue={"categories":[]};
  var Category= tg_getTagFamilies(photosDatabase);
  var i,cat,k,val;
  for (i=0; i<Category.length; i++){
    familyTags_ref = tg_getTags(photosDatabase, Category[i])
    familyTags=[];
    for (k=0; k<familyTags_ref.length; k++){
      // do not display the value already selected
      var toAdd=true;
      for (cat=0; cat<criteria.currentSearch.length; cat++){
        // TODO : loop on the criteria.currentSearch[j].value[0]
        // TODO : make a function tg_isInCriteria({category, value})
        for (val=0; val<criteria.currentSearch[cat].values.length; val++){
          if((Category[i] == criteria.currentSearch[cat].category) && (familyTags_ref[k] == criteria.currentSearch[cat].values[val])){
            toAdd=false;
          }
        }
      }
      if(toAdd == true){      
       familyTags.push(familyTags_ref[k]);
      }
    }
    if(familyTags.length > 0){
      CategoryAndValue.categories.push({"name":Category[i],"values":familyTags})
    }
  }
  return CategoryAndValue;
}

function refresh(){
  var CategoryAndValue = computeCategory();
  selectedPhotos = tg_getPhotos(photosDatabase,criteria)

  // Current search
  //Grab the inline template
  // TODO : make a function tg_criteriaIsEmpty
  if(criteria.currentSearch.length > 0){
    var mytemplate = document.getElementById('search_tpl')
    var template = mytemplate.innerHTML;
    //Parse it (optional, only necessary if template is to be used again)
    Mustache.parse(template);
    //Render the data into the template
    var rendered = Mustache.render(template, tg_getCriteriaToRenderSearchPanel());
    //Overwrite the contents of #target with the rendered HTML
    document.getElementById('search').innerHTML = rendered;
  }else{
    document.getElementById('search').innerHTML = "";
  }
  
  // TAGS
  //Grab the inline template
  var mytemplate = document.getElementById('tags_tpl')
  var template = mytemplate.innerHTML;
  //Parse it (optional, only necessary if template is to be used again)
  Mustache.parse(template);
  //Render the data into the template
  var rendered = Mustache.render(template, CategoryAndValue);
  //Overwrite the contents of #target with the rendered HTML
  document.getElementById('tags').innerHTML = rendered;

  // PHOTOS
  //Grab the inline template
  var mytemplate = document.getElementById('photos_tpl')
  var template = mytemplate.innerHTML;
  //Parse it (optional, only necessary if template is to be used again)
  Mustache.parse(template);
  //Render the data into the template
  var rendered = Mustache.render(template, {"selectedPhotos":selectedPhotos});
  //Overwrite the contents of #target with the rendered HTML
  document.getElementById('photos').innerHTML = rendered;
}

</script>

</body>
</html>
